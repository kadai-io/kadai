name: CI
on:
  workflow_dispatch:
  push:
    branches-ignore:
      - dependabot/**
    tags:
      - v[0-9]+\.[0-9]+\.[0-9]+
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.repository }}-${{ github.event_name }}/${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: 17
  NODE_VERSION: 22.16.x

  ARTIFACTS_CYPRESS_TESTS_NAME: cypress-tests
  ARTIFACTS_CYPRESS_TESTS_PATH: web/cypress
  ARTIFACTS_KADAI_JARS_NAME: kadai-jars
  ARTIFACTS_KADAI_JARS_PATH: ~/.m2/repository/io/kadai
  ARTIFACTS_KADAI_WEB_NAME: kadai-web
  ARTIFACTS_KADAI_WEB_PATH: web/dist
  ARTIFACTS_JACOCO_REPORTS_NAME: jacoco-reports
  ARTIFACTS_JACOCO_REPORTS_PATH: "**/jacoco.exec"

  CACHE_WEB_NAME: web
  # IMPORTANT: this cannot start with CACHE_MAVEN_NAME's value
  # because the 'compile_backend' job would otherwise use this as a fallback cache.
  CACHE_MAVEN_FOR_WEB_NAME: mvn-for-web
  CACHE_MAVEN_NAME: maven
  CACHE_SONAR_NAME: sonar

jobs:
  detect_changes:
    name: Detect changed files and modules
    runs-on: ubuntu-22.04
    outputs:
      # High-level triggers
      backend_changed: ${{ steps.filter.outputs.backend }}
      frontend_changed: ${{ steps.filter.outputs.frontend }}
      
      # Core modules (require full test suite)
      core_modules_changed: ${{ steps.filter.outputs.core_modules }}
      
      # Leaf modules (selective testing)
      kadai_spring_example_changed: ${{ steps.filter.outputs.kadai_spring_example }}
      kadai_loghistory_provider_changed: ${{ steps.filter.outputs.kadai_loghistory_provider }}
      kadai_simplehistory_provider_changed: ${{ steps.filter.outputs.kadai_simplehistory_provider }}
      kadai_simplehistory_rest_spring_changed: ${{ steps.filter.outputs.kadai_simplehistory_rest_spring }}
      kadai_spi_routing_dmn_router_changed: ${{ steps.filter.outputs.kadai_spi_routing_dmn_router }}
      kadai_routing_rest_changed: ${{ steps.filter.outputs.kadai_routing_rest }}
      kadai_rest_spring_example_boot_changed: ${{ steps.filter.outputs.kadai_rest_spring_example_boot }}
      
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.ref_name }}
          filters: |
            # ================================================================
            # BACKEND & FRONTEND CHANGES
            # ================================================================
            backend:
              - 'common/**'
              - 'lib/**'
              - 'history/**'
              - 'rest/**'
              - 'routing/**'
              - 'ci/**'
              - 'qa/**'
              - 'pom.xml'
              - 'mvnw'
              - 'mvnw.cmd'
              - '.mvn/**'
              - '.github/workflows/continuous-integration.yml'
            
            frontend:
              - 'web/**'
              - '.github/workflows/continuous-integration.yml'
              - 'ci/**' 
            
            # ================================================================
            # CORE MODULES (changes require FULL test suite)
            # ================================================================
            core_modules:
              # Foundation layer
              - 'common/kadai-common-logging/**'
              - 'common/kadai-common/**'
              - 'common/kadai-common-security/**'
              - 'common/kadai-common-data/**'
              
              # Test infrastructure
              - 'common/kadai-common-test/**'
              - 'lib/kadai-test-api/**'
              - 'lib/kadai-core-test/**'
              - 'rest/kadai-rest-spring-test-lib/**'
              
              # Core business logic
              - 'lib/kadai-core/**'
              
              # Framework integration
              - 'lib/kadai-spring/**'
              
              # REST API
              - 'rest/kadai-rest-spring/**'
              
              # Shared example infrastructure
              - 'rest/kadai-rest-spring-example-common/**'
              
              # Infrastructure
              - 'pom.xml'
              - '.github/workflows/**'
              - 'ci/**'
              - 'qa/**'
              - 'mvnw'
              - 'mvnw.cmd'
              - '.mvn/**'
            
            # ================================================================
            # LEAF MODULES (selective testing)
            # ================================================================
            kadai_spring_example:
              - 'lib/kadai-spring-example/**'
            
            kadai_rest_spring_example_boot:
              - 'rest/kadai-rest-spring-example-boot/**'
            
            kadai_loghistory_provider:
              - 'history/kadai-loghistory-provider/**'
            
            kadai_simplehistory_provider:
              - 'history/kadai-simplehistory-provider/**'
            
            kadai_simplehistory_rest_spring:
              - 'history/kadai-simplehistory-rest-spring/**'
            
            kadai_spi_routing_dmn_router:
              - 'routing/kadai-spi-routing-dmn-router/**'
            
            kadai_routing_rest:
              - 'routing/kadai-routing-rest/**'
  compile_backend:
    name: Compile all maven modules
    runs-on: ubuntu-22.04
    steps:
      - name: Start Eco CI Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Build Backend"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: ${{ env.JAVA_VERSION }}
      - name: Cache maven dependencies
        id: cache
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}
      - name: Change versions to match tag
        run: ci/change_version.sh -m .
      - name: Compile & build
        run: ./mvnw -B install -DskipTests -Djacoco.skip
      - name: Eco CI Measurement of mvn install
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "compile_backend: mvn install"
        continue-on-error: true
      - name: Show Eco CI Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          display-badge: true
          pr-comment: false
        continue-on-error: true
      - name: Populate cache
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          ./mvnw -B dependency:go-offline
          ./mvnw -B test -Dtest=GibtEsNet -Dsurefire.failIfNoSpecifiedTests=false
      - name: Upload kadai artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.ARTIFACTS_KADAI_JARS_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_JARS_PATH }}
          if-no-files-found: error
      - name: Remove kadai artifacts from cache
        run: rm -rf ${{ env.ARTIFACTS_KADAI_JARS_PATH }}
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  compile_frontend:
    name: Compile kadai-web
    runs-on: ubuntu-22.04
    steps:
      - name: Start Eco CI Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Build Frontend"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: ${{ env.JAVA_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache web dependencies
        id: web-cache
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: ${{ runner.OS }}-${{ env.CACHE_WEB_NAME }}-${{ hashFiles('**/yarn.lock') }}
      - name: Cache maven dependencies (for web)
        id: maven-cache
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.OS }}-${{ env.CACHE_MAVEN_FOR_WEB_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.OS }}-${{ env.CACHE_MAVEN_FOR_WEB_NAME }}
      - name: Populate maven cache
        run: ./mvnw -B dependency:go-offline -pl :kadai-web -am
        if: steps.maven-cache.outputs.cache-hit != 'true'
      - name: Install Dependencies
        if: steps.web-cache.outputs.cache-hit != 'true'
        working-directory: web
        run: yarn install && yarn ci
      - name: Compile & build
        working-directory: web
        run: |
          yarn lint
          yarn build:prod
      - name: Eco CI Measurement of yarn build
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "compile_frontend: yarn build"
        continue-on-error: true
      - name: Build maven artifact
        run: ./mvnw -B install -pl :kadai-web -am
      - name: Eco CI Measurement of mvn :kadai-web
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "compile_frontend: mvn :kadai-web"
        continue-on-error: true
      - name: Show Eco CI Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          display-badge: true
          pr-comment: false
        continue-on-error: true
      - name: Upload kadai-web dist artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.ARTIFACTS_KADAI_WEB_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_WEB_PATH }}
          if-no-files-found: error
      - name: Remove kadai artifacts from cache
        run: rm -rf ~/.m2/repository/io/kadai
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  generate_backend_test_matrices:
    name: Generate backend test matrices
    runs-on: ubuntu-22.04
    needs: [detect_changes]
    if: needs.detect_changes.outputs.backend_changed == 'true'
    outputs:
      matrix_17: ${{ steps.set-matrices.outputs.matrix_17 }}
      matrix_21: ${{ steps.set-matrices.outputs.matrix_21 }}
    steps:
      - name: Determine test matrices
        id: set-matrices
        run: |
          CORE_CHANGED="${{ needs.detect_changes.outputs.core_modules_changed }}"
        
          if [ "$CORE_CHANGED" == "true" ]; then
            # Full test suite - use compact JSON (single line)
            MATRIX_17='{"include":[{"module":"kadai-common","database":"H2"},{"module":"kadai-common-security","database":"H2"},{"module":"kadai-common-data","database":"H2"},{"module":"kadai-common-logging","database":"H2"},{"module":"kadai-common-test","database":"H2"},{"module":"kadai-core","database":"H2"},{"module":"kadai-core","database":"POSTGRES"},{"module":"kadai-core","database":"DB2"},{"module":"kadai-core-test","database":"H2"},{"module":"kadai-core-test","database":"POSTGRES"},{"module":"kadai-core-test","database":"DB2"},{"module":"kadai-test-api","database":"H2"},{"module":"kadai-test-api","database":"POSTGRES"},{"module":"kadai-test-api","database":"DB2"},{"module":"kadai-spring","database":"H2"},{"module":"kadai-spring-example","database":"H2"},{"module":"kadai-spi-routing-dmn-router","database":"H2"},{"module":"kadai-routing-rest","database":"H2"},{"module":"kadai-rest-spring","database":"H2"},{"module":"kadai-rest-spring-test-lib","database":"H2"},{"module":"kadai-rest-spring-example-common","database":"H2"},{"module":"kadai-loghistory-provider","database":"H2"},{"module":"kadai-simplehistory-provider","database":"H2"},{"module":"kadai-simplehistory-provider","database":"POSTGRES"},{"module":"kadai-simplehistory-provider","database":"DB2"},{"module":"kadai-simplehistory-rest-spring","database":"H2"},{"module":"kadai-rest-spring-example-boot","database":"H2"},{"module":"kadai-rest-spring-example-boot","database":"POSTGRES"},{"module":"kadai-rest-spring-example-boot","database":"DB2"}]}'
            
            MATRIX_21='{"include":[{"module":"kadai-routing-rest","database":"DB2"},{"module":"kadai-rest-spring-example-boot","database":"DB2"},{"module":"kadai-simplehistory-rest-spring","database":"DB2"},{"module":"kadai-rest-spring-example-common","database":"DB2"}]}'
          else
            # Selective testing - start with empty
            MATRIX_17='{"include":[]}'
            MATRIX_21='{"include":[]}'
            
            # kadai-spring-example: H2 only
            if [ "${{ needs.detect_changes.outputs.kadai_spring_example_changed }}" == "true" ]; then
              MATRIX_17=$(echo "$MATRIX_17" | jq -c '.include += [{"module":"kadai-spring-example","database":"H2"}]')
            fi
            
            # kadai-loghistory-provider: H2 only
            if [ "${{ needs.detect_changes.outputs.kadai_loghistory_provider_changed }}" == "true" ]; then
              MATRIX_17=$(echo "$MATRIX_17" | jq -c '.include += [{"module":"kadai-loghistory-provider","database":"H2"}]')
            fi
            
            # kadai-simplehistory-provider: H2, POSTGRES, DB2
            if [ "${{ needs.detect_changes.outputs.kadai_simplehistory_provider_changed }}" == "true" ]; then
              MATRIX_17=$(echo "$MATRIX_17" | jq -c '.include += [{"module":"kadai-simplehistory-provider","database":"H2"},{"module":"kadai-simplehistory-provider","database":"POSTGRES"},{"module":"kadai-simplehistory-provider","database":"DB2"}]')
            fi
            
            # kadai-simplehistory-rest-spring: H2 (JDK17), DB2 (JDK21)
            if [ "${{ needs.detect_changes.outputs.kadai_simplehistory_rest_spring_changed }}" == "true" ]; then
              MATRIX_17=$(echo "$MATRIX_17" | jq -c '.include += [{"module":"kadai-simplehistory-rest-spring","database":"H2"}]')
              MATRIX_21=$(echo "$MATRIX_21" | jq -c '.include += [{"module":"kadai-simplehistory-rest-spring","database":"DB2"}]')
            fi
            
            # kadai-spi-routing-dmn-router: H2 only
            if [ "${{ needs.detect_changes.outputs.kadai_spi_routing_dmn_router_changed }}" == "true" ]; then
              MATRIX_17=$(echo "$MATRIX_17" | jq -c '.include += [{"module":"kadai-spi-routing-dmn-router","database":"H2"}]')
            fi
            
            # kadai-routing-rest: H2 (JDK17), DB2 (JDK21)
            if [ "${{ needs.detect_changes.outputs.kadai_routing_rest_changed }}" == "true" ]; then
              MATRIX_17=$(echo "$MATRIX_17" | jq -c '.include += [{"module":"kadai-routing-rest","database":"H2"}]')
              MATRIX_21=$(echo "$MATRIX_21" | jq -c '.include += [{"module":"kadai-routing-rest","database":"DB2"}]')
            fi
            
            # kadai-rest-spring-example-boot: H2, POSTGRES, DB2 (JDK17 & JDK21)
            # Has leaf-to-leaf dependencies
            if [ "${{ needs.detect_changes.outputs.kadai_rest_spring_example_boot_changed }}" == "true" ] || \
              [ "${{ needs.detect_changes.outputs.kadai_spi_routing_dmn_router_changed }}" == "true" ] || \
              [ "${{ needs.detect_changes.outputs.kadai_routing_rest_changed }}" == "true" ]; then
              MATRIX_17=$(echo "$MATRIX_17" | jq -c '.include += [{"module":"kadai-rest-spring-example-boot","database":"H2"},{"module":"kadai-rest-spring-example-boot","database":"POSTGRES"},{"module":"kadai-rest-spring-example-boot","database":"DB2"}]')
              MATRIX_21=$(echo "$MATRIX_21" | jq -c '.include += [{"module":"kadai-rest-spring-example-boot","database":"DB2"}]')
            fi
          fi
          
          # Output compact JSON
          echo "matrix_17=$MATRIX_17" >> $GITHUB_OUTPUT
          echo "matrix_21=$MATRIX_21" >> $GITHUB_OUTPUT
          
          # Pretty print for logs (optional, for debugging)
          echo "=== JDK 17 Matrix ==="
          echo "$MATRIX_17" | jq '.'
          echo "=== JDK 21 Matrix ==="
          echo "$MATRIX_21" | jq '.'

  test_frontend:
    runs-on: ubuntu-22.04
    name: Test kadai-web
    needs: [detect_changes, compile_frontend]
    if: needs.detect_changes.outputs.frontend_changed == 'true'
    steps:
      - name: Start Eco CI Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Test Frontend"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
      - name: Enable Corepack
        run: corepack enable
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache web dependencies
        id: web-cache
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: ${{ runner.OS }}-${{ env.CACHE_WEB_NAME }}-${{ hashFiles('**/yarn.lock') }}
      # Theoretically this step below not necessary because we reuse the cache from the 'compile_frontend' job.
      # Sometimes the cache is not created, therefore this is a fallback.
      - name: Install Dependencies
        if: steps.web-cache.outputs.cache-hit != 'true'
        working-directory: web
        run: yarn ci
      - name: Cache maven dependencies (for web)
        id: maven-cache
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.OS }}-${{ env.CACHE_MAVEN_FOR_WEB_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.OS }}-${{ env.CACHE_MAVEN_FOR_WEB_NAME }}
      # Theoretically this step below not necessary because we reuse the cache from the 'compile_frontend' job.
      # Sometimes the cache is not created, therefore this is a fallback.
      - name: Populate cache
        run: ./mvnw -B dependency:go-offline -pl :kadai-web -am
        if: steps.maven-cache.outputs.cache-hit != 'true'
      - name: Test
        working-directory: web
        run: yarn run test --coverageReporters text-summary
      - name: Eco CI Measurement of web unit tests
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "test_frontend: web unit tests"
        continue-on-error: true
      - name: Show Eco CI Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          display-badge: true
          pr-comment: false
        continue-on-error: true
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  test_e2e:
    runs-on: ubuntu-22.04
    name: Test E2E
    needs: [detect_changes, compile_frontend, compile_backend]
    steps:
      - name: Start Eco CI Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Test e2e"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: ${{ env.JAVA_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache web dependencies
        id: web-cache
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: ${{ runner.OS }}-${{ env.CACHE_WEB_NAME }}-${{ hashFiles('**/yarn.lock') }}
      # Theoretically this step below not necessary because we reuse the cache from the 'compile_frontend' job.
      # Sometimes the cache is not created, therefore this is a fallback.
      - name: Install Dependencies
        if: steps.web-cache.outputs.cache-hit != 'true'
        working-directory: web
        run: yarn ci
      - name: Cache maven dependencies
        id: maven-cache
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}-${{ hashFiles('**/pom.xml') }}
      - name: Download kadai artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_JARS_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_JARS_PATH }}
      - name: Change versions to match tag
        run: ci/change_version.sh -m .
        # Theoretically this step below not necessary because we reuse the cache from the 'compile_frontend' job.
        # Sometimes the cache is not created, therefore this is a fallback.
      - name: Populate cache
        run: ./mvnw -B dependency:go-offline -pl :kadai-rest-spring-example-boot -am
        if: steps.maven-cache.outputs.cache-hit != 'true'
      - name: Download kadai-web dist artifact
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_WEB_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_WEB_PATH }}
      - name: Build frontend
        run: ./mvnw install -pl :kadai-web
      - name: Cypress tests
        working-directory: web
        run: |
          ../mvnw -B spring-boot:run -P history.plugin -f .. -pl :kadai-rest-spring-example-boot &> /dev/null &
          npx wait-port -t 30000 localhost:8080 && yarn run e2e-standalone --spec "cypress/e2e/monitor/**"
      - name: Eco CI Measurement of cypress e2e
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "test_e2e: cypress"
        continue-on-error: true
      - name: Show Eco CI Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          pr-comment: false
          display-badge: true
        continue-on-error: true
      - name: Upload Cypress tests
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.ARTIFACTS_CYPRESS_TESTS_NAME }}
          path: ${{ env.ARTIFACTS_CYPRESS_TESTS_PATH }}
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  test_backend_17:
    runs-on: ubuntu-22.04
    name: Test ${{ matrix.module }} with JDK 17 on ${{ matrix.database }}
    needs: [detect_changes, compile_backend, generate_backend_test_matrices]
    if: needs.generate_backend_test_matrices.outputs.matrix_17 != '{"include":[]}'
    strategy:
      matrix: ${{ fromJson(needs.generate_backend_test_matrices.outputs.matrix_17) }}
    steps:
      - name: Start Eco CI Measurement
        if: matrix.database == 'H2'
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Test Backend (H2)"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: ${{ env.JAVA_VERSION }}
      - name: Cache maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}
      - name: Download kadai artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_JARS_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_JARS_PATH }}
      - name: Change versions to match tag
        run: |
          ci/change_version.sh -m .
      - name: Test
        run: ./mvnw -B verify -pl :${{matrix.module}} -Dcheckstyle.skip
        env:
          DB: ${{ matrix.database }}
      - name: Eco CI Measurement of ${{ matrix.module }} (H2)
        if: matrix.database == 'H2'
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "test_backend_17: ${{ matrix.module }} (H2)"
        continue-on-error: true
      - name: Show Eco CI Results
        if: matrix.database == 'H2'
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          display-badge: true
          pr-comment: false
        continue-on-error: true
      - name: Upload JaCoCo Report
        if: matrix.database == 'H2'
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.ARTIFACTS_JACOCO_REPORTS_NAME }}-${{ matrix.module }}
          path: ${{ env.ARTIFACTS_JACOCO_REPORTS_PATH }}
          if-no-files-found: ignore
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  test_backend_21:
    runs-on: ubuntu-22.04
    name: Test ${{ matrix.module }} with JDK 21 on ${{ matrix.database }}
    needs: [detect_changes, compile_backend, generate_backend_test_matrices ]
    if: needs.generate_backend_test_matrices.outputs.matrix_21 != '{"include":[]}'
    strategy:
      matrix: ${{ fromJson(needs.generate_backend_test_matrices.outputs.matrix_21) }}
    steps:
      - name: Start Eco CI Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Test Backend (JDK21/DB2)"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: 21
      - name: Cache maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}
      - name: Download kadai artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_JARS_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_JARS_PATH }}
      - name: Change versions to match tag
        run: |
          ci/change_version.sh -m .
      - name: Test
        run: ./mvnw -B test -pl :${{matrix.module}} -Dcheckstyle.skip -D"java.version=21"
        env:
          DB: ${{ matrix.database }}
      - name: Eco CI Measurement of ${{ matrix.module }} (JDK21/DB2)
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "test_backend_21: ${{ matrix.module }} (DB2)"
        continue-on-error: true
      - name: Show Eco CI Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          display-badge: true
          pr-comment: false
        continue-on-error: true
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  add-copyright:
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && github.ref != 'refs/heads/master' && !startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Add Copyright Headers
        run: |
          YEAR=$(date +%Y)
          LAST_YEAR=$((YEAR - 1))
          for file in $(find . -type f \( -name '*.java' -o -name '*.ts' \)); do
            if grep -q "Copyright \[$LAST_YEAR\] \[envite consulting GmbH\]" "$file"; then
              echo "Updating copyright year in $file"
              sed -i "s/Copyright \[$LAST_YEAR\] \[envite consulting GmbH\]/Copyright [$YEAR] [envite consulting GmbH]/" "$file"
            elif ! grep -q -e "Copyright" -e "License" "$file"; then
              echo "Adding copyright to $file"
              cat LICENSE_HEADER.txt "$file" > temp_file
              mv temp_file "$file"
            fi
          done
          
          for file in $(find . -type f -name '*.html'); do
            if grep -q "Copyright \[$LAST_YEAR\] \[envite consulting GmbH\]" "$file"; then
              echo "Updating copyright year in $file"
              sed -i "s/Copyright \[$LAST_YEAR\] \[envite consulting GmbH\]/Copyright [$YEAR] [envite consulting GmbH]/" "$file"
            elif ! grep -q -e "Copyright" -e "License" "$file"; then
              echo "Adding copyright to $file"
              cat LICENSE_HEADER_HTML.txt "$file" > temp_file
              mv temp_file "$file"
            fi
          done
          
          for file in $(find . -type f -name '*.scss'); do
            if grep -q "Copyright \[$LAST_YEAR\] \[envite consulting GmbH\]" "$file"; then
              echo "Updating copyright year in $file"
              sed -i "s/Copyright \[$LAST_YEAR\] \[envite consulting GmbH\]/Copyright [$YEAR] [envite consulting GmbH]/" "$file"
            elif ! grep -q -e "Copyright" -e "License" "$file"; then
              echo "Adding copyright to $file"
              cat LICENSE_HEADER_SCSS.txt "$file" > temp_file
              mv temp_file "$file"
            fi
          done

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add/update copyright headers" || echo "No changes to commit"
          git push

  release_artifacts:
    runs-on: ubuntu-22.04
    name: Release artifacts to Sonatype-Central
    if: github.repository == 'kadai-io/kadai' && ( startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/master' ) && github.head_ref == ''
    needs: [ test_frontend, test_e2e, test_backend_17, test_backend_21 ]
    # as documented in the gpg manual (https://www.gnupg.org/documentation/manuals/gnupg/Invoking-GPG_002dAGENT.html)
    # we should execute this command before interacting with gpg (otherwise gpg won't work)
    env:
      GPG_TTY: $(tty)
    steps:
      - name: Start Eco CI Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Release"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # necessary for push back
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: ${{ env.JAVA_VERSION }}
      - name: Cache maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}
      - name: Download kadai artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_JARS_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_JARS_PATH }}
      - name: Download kadai-web dist artifact
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_WEB_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_WEB_PATH }}
      - name: Import GPG Key
        run: echo -n "$GPG_KEY" | base64 --decode | gpg --batch --import
        env:
          GPG_KEY: ${{ secrets.GPG_KEY }}
      - name: Change versions to match tag
        run: ci/change_version.sh -m .
      - name: Release artifacts to Sonatype-Central
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Detected version: $VERSION"
          
          # Validate version is not empty/null
          if [[ -z "$VERSION" || "$VERSION" == "null" ]]; then
          echo "CRITICAL ERROR: Version is empty or null!"
          echo "   Detected version: '$VERSION'"
          echo "   Expected:"
          echo "     - Master branch: x.x.x-SNAPSHOT"
          echo "     - Tag (vx.x.x): x.x.x"
          echo "   Possible causes:"
          echo "     - Incorrect tag format"
          echo "     - Missing or invalid <version> in pom.xml"
          exit 1
          fi
          
          if [[ "$GITHUB_REF" == "refs/heads/master" && "$VERSION" == *-SNAPSHOT ]]; then
            echo "Deploying as SNAPSHOT"
            PROFILE="snapshot"
          elif [[ "$GITHUB_REF" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ && "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Deploying as RELEASE"
            PROFILE="release"
          else
            echo "NOT ALLOWED: Invalid combination"
            echo "   GITHUB_REF: $GITHUB_REF"
            echo "   Version: $VERSION"
            echo "   Expected:"
            echo "     - Master branch + SNAPSHOT version (x.x.x-SNAPSHOT), OR"
            echo "     - Tag (vx.x.x) + RELEASE version (x.x.x)"
            exit 1
          fi
          
          echo "Using Maven profile: $PROFILE"
          ./mvnw -B deploy -P $PROFILE \
          --settings ci/mvnsettings.xml -DskipTests -Dcheckstyle.skip -Djacoco.skip \
          -pl :kadai-parent,\
          :kadai-common-parent,:kadai-common-logging,:kadai-common,:kadai-common-security,\
          :kadai-common-data,:kadai-common-test,:kadai-test-api,\
          :kadai-lib-parent,:kadai-core,:kadai-spring,\
          :kadai-rest-parent,:kadai-web,:kadai-rest-spring,\
          :kadai-history-parent,:kadai-simplehistory-provider,:kadai-simplehistory-rest-spring,:kadai-loghistory-provider,\
          :kadai-routing-parent,:kadai-spi-routing-dmn-router,:kadai-routing-rest
        env:
          GPG_KEY_NAME: ${{ secrets.GPG_KEY_NAME }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      - name: Eco CI Measurement of release deploy
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "release_artifacts: mvn deploy"
        continue-on-error: true
      - name: Show Eco CI Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          display-badge: true
          pr-comment: false
        continue-on-error: true
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  update_version:
    runs-on: ubuntu-22.04
    name: Update version to next snapshot and push back
    if: github.repository == 'kadai-io/kadai' && startsWith(github.ref, 'refs/tags/v') && github.head_ref == ''
    needs: [ release_artifacts ]
    permissions:
      contents: write
    steps:
      - name: Git checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # necessary for push back
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update version to next snapshot and push back
        run: |
          ci/change_version.sh -i -m .
          ci/commitPoms.sh
        env:
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  deploy_to_azure:
    runs-on: ubuntu-22.04
    name: Deploy demo app to Microsoft Azure
    if: github.repository == 'kadai-io/kadai' && github.ref == 'refs/heads/master' && github.head_ref == ''
    needs: [ test_frontend, test_e2e, test_backend_17, test_backend_21 ]
    steps:
      - name: Git checkout
        uses: actions/checkout@v5
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: ${{ env.JAVA_VERSION }}
      - name: Cache maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}
      - name: Download kadai artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_JARS_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_JARS_PATH }}
      - name: Download kadai-web dist artifact
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.ARTIFACTS_KADAI_WEB_NAME }}
          path: ${{ env.ARTIFACTS_KADAI_WEB_PATH }}
      - name: Build kadai-web
        run: ./mvnw -B install -pl :kadai-web
      - name: Generate Javadoc
        run: ./mvnw -B clean javadoc:jar -pl :kadai-core,:kadai-spring
      - name: Build Example Application
        run: ./mvnw -B install -P history.plugin -pl :kadai-rest-spring-example-boot -DskipTests -Dcheckstyle.skip -Dmaven.javadoc.skip -Djacoco.skip
      - name: Verify Example Application contains documentation
        run: ci/verify_docs_jar.sh
      - name: Login to Microsoft Azure
        uses: Azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'
      - name: Deploy to Microsoft Azure
        uses: Azure/webapps-deploy@v3
        with:
          app-name: kadai-io
          package: rest/kadai-rest-spring-example-boot/target/kadai-rest-spring-example-boot.jar
      - name: Wait for Azure for 60 seconds
        uses: jakejarvis/wait-action@master
        with:
          time: '60s'
      - name: Smoke test documentation
        run: ci/verify_docs_alive.sh
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5

  upload_to_sonar:
    runs-on: ubuntu-22.04
    name: Upload SonarQube analysis to sonarcloud
    # neither on release nor forks nor dependabot
    if: |
      github.repository == 'kadai-io/kadai' &&
      !startsWith(github.ref, 'refs/tags') &&
      !startsWith(github.head_ref || github.ref_name, 'dependabot/') &&
      github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'
    needs: [ test_frontend, test_e2e, test_backend_17, test_backend_21 ]
    steps:
      - name: Start Eco CI Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: start-measurement
          project: "KADAI"
          tags: "CI/CD, Sonar"
        continue-on-error: true
      - name: Git checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: adopt
          java-version: ${{ env.JAVA_VERSION }}
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-${{ env.CACHE_SONAR_NAME }}
          restore-keys: ${{ runner.os }}-${{ env.CACHE_SONAR_NAME }}
      - name: Cache maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-${{ env.CACHE_MAVEN_NAME }}
      - name: Download JaCoCo reports
        uses: actions/download-artifact@v6
        with:
          pattern: ${{ env.ARTIFACTS_JACOCO_REPORTS_NAME }}-*
          merge-multiple: true
      - name: Install kadai
        run: ./mvnw -B install -DskipTests -Dcheckstyle.skip -Dmaven.javadoc.skip
      - name: Upload SonarQube analysis
        run: ./mvnw -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      - name: Eco CI Measurement of sonar verify
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: get-measurement
          label: "upload_to_sonar: mvn verify + sonar"
        continue-on-error: true
      - name: Show Eco CI Results
        uses: green-coding-solutions/eco-ci-energy-estimation@v5
        with:
          task: display-results
          display-badge: true
          pr-comment: false
        continue-on-error: true
      - name: Cancel workflow
        if: failure()
        uses: andymckay/cancel-action@0.5